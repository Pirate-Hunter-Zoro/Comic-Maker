# Project: Lora-Trainer Forge

This project contains a set of scripts to train multi-concept LoRA models and generate images using them on the LIBR Analysis Cluster. It is a direct translation of an interactive Google Colab workflow into a non-interactive, repeatable set of rituals suitable for a high-performance computing environment.

---

### The Armory Layout

This is the domain you command. Understand its structure.

```text

Visual-Novel-Writer/
├── kohya-trainer/      \# The sd-scripts repo. A necessary evil.
├── lora\_env/           \# Your forged sanctuary of tools. Generated by the setup script.
├── master\_dataset/     \# The souls of your subjects (training images).
│   └── 20\_character\_name/
├── test_scripts/            \# The incantations themselves.
│   └── use\_lora.py
├── logs/               \# The echoes of your rituals (output logs from SLURM).
├── setup\_forge.sh      \# The script to build the sanctuary. Run this first, and only once.
├── submit\_training.ssub
├── submit\_inference.ssub
└── pose\_map.png        \# Your optional, but superior, map for the command ritual.

```

The primary output (trained models and final images) is not stored here. It is banished to the `/media/labs/mferguson/Lora-Trainer/` directory to preserve the meager space in your home directory.

---

### The Order of Operations

Follow these steps precisely. Deviation is for fools and those with power to waste. You are neither.

#### Step 0: The Offering (Prerequisites)

Before you begin any ritual, you must prepare the offerings.

1.  **Populate the Dataset:** Place your training images inside the `master_dataset` folder. Each character or concept must have its own subfolder named in the format `_`, for example, `20_blake_character`.
2.  **Provide a Command Map (Optional):** If you wish to command the final pose of your subjects with precision, create a `1024x768` PNG image with stick figures representing your desired poses. Name it `pose_map.png` and place it in the project root. If you omit this, the inference script will generate a random, and likely inferior, pose map for you.

#### Step 1: Forging the Sanctuary (Environment Setup)

Your tools must be sharp. This ritual forges the `lora_env` Python environment.

-   From the `~/Digital-Novel-Writer/` directory, execute the setup script. You only need to perform this ritual **once**.
    ```bash
    ./setup_forge.sh
    ```

#### Step 2: The Ritual of Training

This ritual commands the `c3_accel` partition to forge a LoRA spirit from your dataset. This is a lengthy process.

-   Submit the training job to the SLURM scheduler:
    ```bash
    sbatch submit_training.ssub
    ```
-   Monitor its progress with `squeue -u $USER`.
-   Your trained `.safetensors` models will appear in `/media/labs/mferguson/Lora-Trainer/Multi_Concept_Output/`.

#### Step 3: The Ritual of Command

Once a spirit has been successfully forged (i.e., at least one `.safetensors` file exists), you may command it to create a vision.

-   Submit the inference job to the SLURM scheduler:
    ```bash
    sbatch submit_inference.ssub
    ```
-   This script automatically finds the latest trained LoRA from the training output directory.
-   The final masterpiece will be sealed at `/media/labs/mferguson/Lora-Trainer/Final_Images/final_command_scene.png`.

---

### Tuning the Instruments

If you wish to alter the rituals, these are the strings to pull:

-   **Storage Location:** The `LAB_STORAGE_ROOT` variable in `test_scripts/use_lora.py` can be changed if you decide to move your armory.
-   **Inference Prompt:** The prompt for the final image is defined within `test_scripts/use_lora.py`.
-   **Job Resources:** The compute resources (time, memory) are defined with `#SBATCH` directives at the top of the `submit_training.ssub` and `submit_inference.ssub` files.

---

### The Anatomy of the Forge: A Grand Overview

This project is a ritual in two acts: **Forging** and **Command**. Its purpose is to teach a powerful but ignorant spirit a new skill, and then command it to use that skill to create visions for you.

#### 1. The Cast of Spirits (The Core Components)

There are three main entities in this ritual:

* **The Base Demon (The `AnyLoRA` Model):** Think of this as a powerful, raw demon of creation. It has immense power and can draw anything, but it has no specific knowledge of your characters. It is the raw energy of the forge.
* **The Offerings (Your `master_dataset`):** These are the souls you feed to the ritual. The images and caption files for each character are the memories and knowledge that will be used to teach the Base Demon.
* **The LoRA Spirit (Your Forged `.safetensors` File):** This is the ultimate prize. It is **not** a new version of the base model. It is a small, separate, parasitic spirit. Think of it as a sentient suit of armor or a weapon. When the Base Demon "wears" this LoRA, it gains the knowledge from your offerings, allowing it to draw your characters with precision. By itself, the LoRA is powerless. It needs the Base Demon to function.

#### 2. The Two Realms (Where Things Are Stored)

The project is split across two domains, each with a specific purpose:

* **Your Home Realm (`~/Digital-Novel-Writer/`): The Command Center**
    This is your personal space. It is small and meant for your tools, not your treasures.
    * **`test_scripts/`**: Contains the sacred scrolls (`use_lora.py`).
    * **`lora_env/`**: The sanctuary where all the lesser tool-spirits (`pip` packages) are bound.
    * **`kohya-trainer/`**: The lair of the beast we have tamed (`train_network.py`, etc.).
    * **`master_dataset/`**: The altar where you place your Offerings.
    * **`.ssub` files**: The command scrolls you use to speak to the cluster's overseer, SLURM.

* **The Great Armory (`/media/studies/ehr_study/data-EHR-prepped/Mikey-Lora-Trainer/`): The Treasury**
    This is the vast, shared space for powerful artifacts. It holds everything too large or important for your home realm.
    * **`AnyLoRA/`**: The prison kingdom of the Base Demon.
    * **`controlnet-model/` & `controlnet-detector/`**: The prisons for the spirits of command and control.
    * **`Multi_Concept_Output/`**: This is where the newly **forged LoRA spirits** are stored after a successful training ritual.
    * **`Final_Images/`**: Where the final, commanded visions (your generated images) are placed.

#### 3. The Order of the Ritual (How It Works)

This is the entire process, from nothingness to a final creation.

1.  **Preparation (A One-Time Task):** You perform the rituals to set up the battlefield. This includes running `setup_lora_env.sh` to build the sanctuary, manually downloading and using `scp` to place the Base Demon and ControlNet spirits in the Great Armory, and performing the "lobotomy" on `train_util.py`. This is all done only once.

2.  **The Forging (`sbatch submit_training.ssub`):** This is the first great act.
    * Your `sbatch` command tells the SLURM overseer to grant you the power of a compute node (one with a GPU).
    * On that node, your `submit_training.ssub` scroll is read.
    * It enters your `lora_env` sanctuary to awaken the necessary tool-spirits.
    * It then executes the lobotomized `train_network.py` script.
    * This script gazes upon the Base Demon in the Great Armory and simultaneously reads the knowledge from your Offerings in your Home Realm.
    * Over thousands of steps, it distills this new knowledge into a small, powerful **LoRA spirit** (`.safetensors` file) and places it in the `Multi_Concept_Output` chamber of the Great Armory.

3.  **The Command (`sbatch submit_inference.ssub`):** This is the final act.
    * You again ask the SLURM overseer for a compute node.
    * Your `submit_inference.ssub` scroll commands it to awaken.
    * It enters the `lora_env` sanctuary.
    * It runs your `use_lora.py` script.
    * This script travels to the Great Armory and summons three spirits: The **Base Demon** (`AnyLoRA`), the **ControlNet** spirit, and your newly forged **LoRA Spirit**.
    * It commands them to work as one. The Base Demon provides the power, the LoRA provides the knowledge of your characters, and the ControlNet provides the pose.
    * The combined power of these three spirits creates your final image, which is then saved to the `Final_Images` chamber in the Great Armory.

That is the entire structure of this war. You prepare the battlefield, forge a new weapon, and then command that weapon in a final strike. It is a powerful, if arduous, process.
